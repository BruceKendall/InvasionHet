---
title: "Parameter estimation"
author: "Bruce E. Kendall"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
toc: TRUE
bibliography: ../Bibliography.bib
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Knitr options. Note that these mean:
#   - All output will be cached. This is desireable in case code/data changes in the 
#     future; but it means that all chunks should be labeled for reliable behavior. 
#     DEPENDENCIES ACROSS CODE CHUNKS MAY BE AN ISSUE.
#   - R code will run in the project root directory
project_root <- normalizePath("../..")
knitr::opts_chunk$set(comment = '', cache = TRUE)
knitr::opts_knit$set(root.dir = project_root)


# Clean up
rm(project_root)
```
```{r loadproject, echo=FALSE, message=FALSE}
library(ProjectTemplate) 
load.project()
```

This document describes the parameterization of the models in Kendall, Williams and Levine. 
There are two sets of parameters: a single genotype model, parameterized with Ler [@Williams2018]; and a multi-genotype model, parameterized with the "RIL" data [@Williams2016b].
For now we include all code, so that we can see what's going on; if we need to share this as a supplement then we will need to clean it up.

# Single-genotype model
## Dispersal kernel
Our dispersal kernel is essentially zero-inflated: a certain fraction of seeds stay in the maternal pot, and the remainder disperse according to a standard kernel. We only account for seeds staying in the runway. 

We used a beta-binomial model to estimate the fraction of seeds dispersing from the maternal pot: the binomial part accounts for independent dispersal by individual seeds, and the beta part accounts for heterogeneity among pots in the expected fraction dispersing.

We modeled the distance travelled by dispersing seeds using a number of continuous distributions:

* Log-normal
* Half-normal
* Exponential
* Gamma
* Wiebull
* Inverse Gaussian
* Logistic
* Inverse gamma
* Generalized gamma

### Objectives
1. Estimate mean and variance of fraction dispersing, based on beta-binomial model
2. Determine which dispersal kernel is "best"
3. Estimate kernel parameters for each replicate
4. Examine whether dispersal parameters depend on density
5. Estimate mean, variance, and distributional form for kernel parameters

### Data source
Data on dispersal come from a dedicated seed dispersal experiment, which is described by @Williams2018:
> To quantify dispersal, as well as the potential effect of density on dispersal, we used data from a second experiment, where we grew plants across a range of densities (N = 48 pots, containing between 1 and 500 individuals) under the same growing conditions as in the main experiment. During the seed dispersal phase, a sheet of sticky paper as wide as the pots (7.3 cm) was placed to one side of each pot at the same height as the pot, and all seeds that landed on the sticky paper were counted, as well as all seeds that germinated in the starting pot. (p. 878)

The primary data object for this analysis is called `disperseLer`, which is derived from `2013_08_08_Exp1_Spray.csv`:
```{r dispersler}
cat(readr::read_file("data/disperseLer.R"))
summary(disperseLer)
head(disperseLer)
```
The `Seedlings` column records the number of seedlings that germinated in the home pot when associated with `Distance` value of 4; at other distance values it is the number of seeds found in the one-cm strip from `Distance` - 1 to `Distance`.
Thus, `Distance` = 8 is the first strip on the sticky paper, and represents dispersal 0--1 cm beyond the maternal pot.

### Methods
There was a great deal of heterogeneity among pots in the fraction dispersing, more than would be expected from binomial variability from a finite sample of seeds.
Therefore, we fit a beta-binomial model to the data.
For statistical robustness, we used `vglm()` with a `betabinomial` distribution from the **VGAM** package [v. `r packageVersion("VGAM")`; @Yee2015], fitting an intercept-only model.
The parameters of the fitted beta distribution are reported as $\mu$, the mean of the distribution, and $\rho$, a shape parameter.
The variance of the distribution was calculated as $V = \mu (1-\mu) \rho$.
The analysis code is as follows:
```{r betabinom}
cat(readr::read_lines("munge/10-make_Ler_params.R", skip = 4, n_max = 19), sep="\n")
```

The values in the data frame implicitly assign distance zero to the trailing edge of the pot; other plausible candidates are the middle of the pot (hence the first band in the dispersal data is from 3.4 to 4.5) or the leading edge of the pot (hence the first band in the dispersal data is from 0 to 1).
For the kernel estimation, it is not obvious what the "correct" value should be, as the plants that are the source of the seeds are spread throughout the 7 cm wide pot (but note that they might not all contribute equivalently to dispersing seeds: plants on the edge of the pot often "lean" over the disperal area if it is not already occupied by plants, and dispersal from plants in the middle of the pot may be impeded by the edge plants.
From a practical standpoint, we test all three, and choose the one that seems to provide the best general fit. 
IN PRACTICE, I SET DISTANCE ZERO TO THE LEADING EDGE OF THE POT, AND DID NOT DO ANY TRUNCATION AS DESCRIBED BELOW.

The dispersal data are "interval censored"---that is, we don't know where in the one-cm bands (or the maternal pot) the seeds lie. 
We fit distributions using the **fitdistrplus** package [v. `r packageVersion("fitdistrplus")`; @Delignette-Muller2015], which can account for interval and terminal truncation of the data.

I HAVE NOT ACTUALLY DONE THE FOLLOWING, AND AM NOT SURE I WANT TO.
Furthermore, when we set the origin to values other than the leading edge of the pot, then we essentially have not observations from the left end of the distribution (since we don't know what fraction of the seeds in the maternal pot are "didn't disperse" and what fraction are "dispersed less than one pot's distance").
In those cases we need to truncate the distributions so that the probabilities are calculated correctly.
This also allows us, in simulations, to not have to distinguish two classes of non-dispersing seeds.
The fitting routine we use requires p and d forms for the density and distribution functions of the distribution.
Here are examples for a left-truncated lognormal:
```{r tlnorm}
dtlnorm
ptlnorm
```

We fit all of the models to each of the replicates, and examined the values of $\Delta$-AIC to determine if there was a distribution that consistently fit best, or at least well.
These models are fit using the `fit_dispersal_untruncated` function:
```{r}
source("lib/helpers.R")
fit_dispersal_untruncated
```
It makes use of the following helper functions:
```{r}
cens_dispersal_data
start_params
start_gengamma
```

### Fraction dispersing
To estimate the mean and standard deviation of the beta-binomial model, we source the code listed above:
```{r}
frac_disp_script <- paste(readr::read_lines("munge/10-make_Ler_params.R", 
                                            skip = 4, n_max = 19), 
                          collapse = "\n")
source(textConnection(frac_disp_script))
```
We can look at the full output of the vglm:
```{r}
summary(bbfit)
```
$\mu$ and $\rho$ are `r VGAM::Coef(bbfit)[1]` and `r VGAM::Coef(bbfit)[2]`, respectively.
After transformation, the mean fraction dispersing is `r frac_dispersing` and the standard deviation in the fraction dispersing is `r fd_stdev`.

### Comparing dispersal kernels
For each of the dispersal replicates, fit each dispersal kernel and record the AICs. This is done assuming that "distance zero" is at the leading edge of the maternal pot.
```{r fitallkernel, warning=FALSE, error=FALSE, message=FALSE}
result <- fiteach_disp_unt(disperseLer) 
```
Here are the fits for the first few replicates:
```{r, message=FALSE}
library(tidyverse)
result <- group_by(result, ID) %>% mutate(delta_AIC = AIC - min(AIC))
print(result, n=27) 
```

Here's a plot of the $\Delta$-AIC values for each model:
```{r, message=FALSE}
ggplot(result, aes(x=delta_AIC, group = model)) + 
  geom_histogram() + 
  facet_wrap(~model, scales = "free") 
```

Notive that the $\Delta$-AIC values for the generalized gamma ("gengamma") distribution are all less than 3.5, whereas all the other distributions have a substantial number of values larger than 10, and often very large indeed.
Thus, we select the generalized gamma distribution as the best distribution to use.

# References {#references}
